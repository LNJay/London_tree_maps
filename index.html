<!DOCTYPE html>

<!-- https://leafletjs.com/examples/quick-start/-->
<html>
    <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <!-- <script src="https://unpkg.com/leaflet-locatecontrol/0.81.0/L.Control.Locate.min.js></script> -->
    <!-- //https://github.com/domoritz/leaflet-locatecontrol/blob/gh-pages/dist/L.Control.Locate.min.js -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="/MarkerCluster.css">
    <link rel="stylesheet" href="/MarkerCluster.Default.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <style> </style>

    <link rel="stylesheet" href="/style.css">

   
    <!-- font-size:50px; -->
<!--     <popup>
        font-size:20px;

    </popup> -->
    </head>
    <body>
    <h1>London Tree Map Data</h1>
    <div class="form-inputs">
        <!-- <div class="form-field">
            <label for="search-input">Search:</label>   
            <input id="search-input"/>
        </div> -->
        
        <div class="form-field">
            <label for="species-input">Enter a tree by common or species name:</label>
            <input  id="species-input" autoComplete="on" list="species-datalist"/>     
        </div>   

        <div class="form-field">
            <label for="borough-input">If desired enter a borough:</label>
            <input  id="borough-input" autoComplete="on" list="borough-datalist"/>     
        </div>    
                
    </div>
    
    <datalist id="species-datalist">

    </datalist>

    <datalist id="borough-datalist">

    </datalist>


    <!-- experimental code -->
    <div id="controller1" class="controlers-filters categoryFilter">

    </div>
    
    <!-- experimental code end -->
<!--     <select onchange="handleChange(this)">
        <option>Prunus</option>
        <option>Acer</option>
    </select> -->

<!--     <label for="genus-select">Select a genus:</label>
    <select id="genus-select">
    <option value="">Select a genus</option>
    </select>


    <label for="species-select">Select a species:</label>
    <select id="species-select">
    <option value="">Select a species</option>
    </select>
 -->



    <!-- <p>This is a paragraph.</p> -->

    <div id="map"></div>

    <script>

/* function handleChange(selectElement) {
   //console.log("CHANGE", selectElement)
   var selectedValue = selectElement.value;
   console.log('Selected value:', selectedValue);
   return selectedValue;

}
 */
 


var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
});

var osmHOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team hosted by OpenStreetMap France'});

var map = L.map('map', {
    center: [51.55, -0.196],
    zoom: 15,
    layers: [osm]

});

// var marker = L.marker([51.546009, -0.20193]).addTo(map);
//     marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();

//add users location to the map


//This works for adding search restricted to UK
// L.Control.geocoder({
//     geocoder: L.Control.Geocoder.nominatim({
//         geocodingQueryParams: {countrycodes: 'gb'}
//     })
// }).addTo(map);

//need to remove the geocoder map point when you do a new search

let currentMarker;

L.Control.geocoder({
    geocoder: L.Control.Geocoder.nominatim({
     geocodingQueryParams: {countrycodes: 'gb'}
    })
  // other options
})
.on("markgeocode", function (e) {
  // Remove the previous marker, if it exists
  if (currentMarker) {
    map.removeLayer(currentMarker);
  }

  // Add the new marker
  let latlng = e.geocode.center;
  currentMarker = L.marker(latlng, {color: 'green'}).addTo(map);
  currentMarker._icon.classList.add("huechange2");
  currentMarker.bindPopup(e.geocode.name).openPopup();
  map.panTo(latlng);



  // Update the printInfo state
  setPrintinfo(e.geocode.name);
})
.addTo(map);



if ("geolocation" in navigator) {
  console.log("Geolocation is supported")
} else {
    console.log("Geolocation is not supported")
}

// navigator.geolocation.getCurrentPosition(
//   (position) => {
//     // Get the latitude and longitude coordinates
//     const { latitude, longitude } = position.coords;
//     // Use the coordinates to display the user's location on a map
//     showUserLocationOnMap(latitude, longitude);
//   },
//   (error) => {
//     // Handle any errors that occur
//     console.error("Error getting location:", error);
//   }
// );

// function showUserLocationOnMap(latitude, longitude) {
//       // Add a marker to the map at the user's location
//   var marker = L.marker([latitude, longitude], {color: 'red'}).addTo(map);
//   marker._icon.classList.add("huechange"); //https://stackoverflow.com/questions/23567203/leaflet-changing-marker-color
//   marker.bindPopup("<b>Your location</b>").openPopup();
  
// }


//L.Control.locate().addTo(map)
let locoMarker;

class LocateControl extends L.Control {
  constructor(options = {}) {
    super(options);
  }

  onAdd(map) {
    const container = L.DomUtil.create("div", "leaflet-bar leaflet-control leaflet-control-custom");
    container.innerHTML = '<a href="#" class="leaflet-control-locate leaflet-control-locate-icon"><i class="fa fa-map-marker"></i></a>';
    container.onclick = () => {
      this.locate(map);
    };
    return container;
  }

  locate(map) {
    if (locoMarker) {
        map.removeLayer(locoMarker);
    }
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        map.flyTo([latitude, longitude], 15);
        locoMarker = L.marker([latitude, longitude]).addTo(map);
        locoMarker._icon.classList.add("huechange");
        locoMarker.bindPopup("<b>Your location</b>").openPopup()
      },
      (error) => {
        console.error("Error getting location:", error);
      }
    );
  }
}

const locateControl = new LocateControl();
locateControl.addTo(map);


// var baseMaps = {
//     "OpenStreetMap": osm,
//     /*"OpenStreetMap.HOT": osmHOT*/
// };


function search_matches(search,feature) {
    if (search.match(/['"]/)){

if (feature.properties.scientificname.toLowerCase().includes(search.trim().toLowerCase()) || feature.properties.commonname.toLowerCase().includes(search.trim().toLowerCase())) {
        return true;
    }  


} else {

if (feature.properties.scientificname.toLowerCase().replace(/['"]/g, "").includes(search.trim().toLowerCase()) || feature.properties.commonname.toLowerCase().replace(/['"]/g, "").includes(search.trim().toLowerCase())) {
        return true;
    }    

}

}


function borough_matches(borough,feature) {
    if (borough.match(/['"]/)){

if (feature.properties.wardname.toLowerCase().includes(borough.trim().toLowerCase())) {
        return true;
    }  


} else {

if (feature.properties.wardname.toLowerCase().replace(/['"]/g, "").includes(borough.trim().toLowerCase())) {
        return true;
    }    

}

}



/*->filter geojson data*/
function filterGeojson(search /* : (feature) -> bool,  : { search_term: string, location: [number, number], distance: number } */,borough, geojsondata) {
    //console.log(geojsondata)
    return geojsondata.features.filter( function (feature) {

        return search_matches(search, feature) && borough_matches(borough, feature)
        
    });

}



const geojsonMarkerOptions={}

function layerFromGeojson(geojsondata)/*->take geojson data and return a layer*/{
    
    const lightlayers = L.geoJSON(geojsondata, {
            onEachFeature: function(feature, layer) {
                if (feature.properties && feature.properties.popupContent) {
                    layer.bindPopup(feature.properties.popupContent);
                }    
            },
            pointToLayer: function(feature,latlng) {
                
                return L.circleMarker(latlng, geojsonMarkerOptions);              
            }
        });
    return L.markerClusterGroup().addLayer(lightlayers);
}








let geolayer

function updateLayers(search, borough, geojsondata){
    

    //genusSelect.addEventListener('change', function(event) {
    if (geolayer) {
        map.removeLayer(geolayer)
    }

    
    const filteredData = filterGeojson(search, borough, geojsondata)

    geolayer =  layerFromGeojson(filteredData)

    // Calculate the center point and zoom level
    const bounds = L.geoJSON(filteredData).getBounds();
    const center = bounds.getCenter();
    const zoom = map.getBoundsZoom(bounds);

    // Center the map with a smooth animation
    map.flyTo(center, zoom);

    

    geolayer.addTo(map)


    

    // const geoJsonLayer = geolayer.addTo(map);
    // const markers = L.markerClusterGroup({
//   spiderfyOnMaxZoom: false,
//   showCoverageOnHover: false,
//   zoomToBoundsOnClick: true
// });
//     geoJsonLayer.eachLayer(function(layer) {
//     if (layer instanceof L.Marker) {
//         markers.addLayer(layer);
//     }
// });
// map.addLayer(markers);



}

function addspeciesToDropdown(geojsondata) {
  var speciesSelect = document.getElementById('species-datalist');//species-datalist
  //console.log(speciesSelect)

  for (const scientificname of sortanddedupe(geojsondata.features)){




    var option = document.createElement('option');
    option.value = scientificname;
    option.text = scientificname;
    speciesSelect.appendChild(option);
   
   //console.log(feature.properties.scientificname) 


   // Create a new option element
//    var option = document.createElement('option');
//    option.value = feature.properties.scientificname; // Use a unique property as the value
//    option.text = feature.properties.scientificname; // Display the name property

//    // Add the option to the dropdown
//    speciesSelect.appendChild(option);

}

    


    
   
    
 
};

function sortanddedupe(features){
    const listofspecies = []
    for (const feature of features){
        listofspecies.push(feature.properties.scientificname)
    }
    listofspecies.sort()
    return [...new Set(listofspecies)];    

}


//Add boroughs to datalist

function addboroughToDropdown(geojsondata) {
  var boroughSelect = document.getElementById('borough-datalist');
  //console.log(speciesSelect)

  for (const wardname of sortanddedupeb(geojsondata.features)){




    var option = document.createElement('option');
    option.value = wardname;
    option.text = wardname;
    boroughSelect.appendChild(option);
   
   //console.log(feature.properties.wardname) 


   

}

};

function sortanddedupeb(features){
    const listofboroughs = []
    for (const feature of features){
        listofboroughs.push(feature.properties.wardname)
    }
    listofboroughs.sort()
    return [...new Set(listofboroughs)];    

}



//////////////////

async function addgeojsonFeature(geofile,layername) {
    const response = await fetch(geofile);

    const geojsondata = await response.json();
   //console.log(geojsondata)


    updateLayers("", "", geojsondata)

    
    // const inputSelect = document.getElementById('search-input');
    // inputSelect.addEventListener('input', function(event) {
        
    //     const search = event.target.value;
    //     //console.log(search)
    //     updateLayers(search, geojsondata)
    // }
       
    // )

    const inputSelect2 = document.getElementById('species-input');
    const inputSelect3 = document.getElementById('borough-input');
    const handleChange=()=>{        
        const borough = inputSelect3.value;
        const search = inputSelect2.value;
        updateLayers(search, borough, geojsondata)
    }
    inputSelect2.addEventListener('input', handleChange)


    
    inputSelect3.addEventListener('input', handleChange)


    
    
    addspeciesToDropdown(geojsondata)
    addboroughToDropdown(geojsondata)
    

}




addgeojsonFeature("/camden_full.geojson","Trees")

//const layerControl = L.control.layers(baseMaps).addTo(map);





 




    </script>

</body>
</html>